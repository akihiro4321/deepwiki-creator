# Wiki構造 生成ガイドライン

## 入力（3つ全てを読み込むこと）

1. `deepwiki_tree.txt`: リポジトリのファイルツリー
2. `deepwiki_readme.md`: READMEの内容
3. **`deepwiki_recon.md`: コード偵察結果**（最重要）

## 構造設計の原則

1. **偵察結果から機能を特定する**: ディレクトリ名ではなく、export と拡張機構定義から把握
2. **ユーザー視点で構成する**: 「理解したい開発者が読む順番」で構成
3. **概要 → 詳細**: 最初のセクションは必ずプロジェクト全体の概要
4. **1ページ = 1つの論理的な関心事**
5. **拡張機構は必ずカバーする**

## 必須ページタイプ（Comprehensiveモード）

### エンドツーエンドフローページ（必須）

**Comprehensiveモードでは、以下のページを必ず1つ以上含めること：**

モジュールを横断する処理フローを、具体的なコードパスとともに解説するページ。
特定のコンポーネントの内部実装ではなく、「入力から出力まで」の全体の流れを追う。

推奨ページID: `end-to-end-flow` または `request-lifecycle`

**内容：**
- ユーザーの入力がどのモジュールを経由して最終出力に至るか
- 各ステップで受け渡されるデータの型と内容
- ツール呼び出し発生時の分岐フロー
- エラー発生時のリカバリーフロー
- 詳細なsequenceDiagram（alt/opt分岐を含む）

**relevant_files**: エントリーポイント、コアクラス、ツール実行クラスなど横断的に指定

### 拡張機構ページ

偵察結果のセクション3に検出がある場合、それを解説するページを含める。

**加えて、偵察では検出しきれない拡張ポイントも確認する：**
READMEに「プラグイン」「カスタム」「拡張」等のキーワードがある場合、
コード内にその仕組みを実装するファイル（ローダー、パーサー等）があるはず。
偵察結果のexport一覧から `load*`, `parse*`, `discover*`, `register*` 等の
関数を探し、対応するファイルを relevant_files に含める。

## プロジェクトタイプ別のセクション設計

偵察結果から判断できるプロジェクトタイプに応じて適切な構成を選択する。

### CLIツール / エージェント
概要 / エンドツーエンドフロー / コアロジック / 拡張機構 / 設定・認証 / 品質・テスト

### Webアプリケーション
概要 / リクエストライフサイクル / ルーティング / ビジネスロジック / データ層 / 認証

### ライブラリ / SDK
概要 / Public API / ユースケースフロー / 内部アーキテクチャ / 設定 / テスト

### モノレポ
概要 / パッケージ間連携フロー / 各パッケージ詳細 / 共通基盤 / 開発ガイド

## モード別の設計指針

### Comprehensive（**15〜25ページ。15ページ未満は不可。**）
- 全主要モジュールをカバー
- セクション3〜7個
- **エンドツーエンドフローページ必須**
- **拡張機構ページ必須（検出があれば）**
- READMEに記載されている全機能に対応ページがあること

**必須カバレッジ領域（該当するものは全てページを設ける）：**
- プロジェクト概要 / アーキテクチャ
- エンドツーエンドフロー（リクエストライフサイクル）
- コアロジック（セッション管理、状態管理）
- ツールシステム（レジストリ、組み込みツール）
- 外部統合（MCP、API通信、IDE連携等）
- エージェント / マルチエージェント
- セキュリティ / ポリシー / 認証
- 設定 / ストレージ / 環境管理
- メモリ / コンテキスト管理（該当する場合）
- ユーザー拡張機構（スキル、カスタムコマンド、フック等）
- CLI / UI 実装
- テスト / 品質基盤

**初回設計で10〜14ページになった場合：** 以下の手順で不足ページを追加し、**15ページ以上**にすること。

**ページ数不足時の自動補完手順：**

1. 上記12領域のチェックリストを1つずつ確認する
2. 該当するのに独立ページがない領域を特定する
3. 以下の優先順位でページを追加する：
   - **最優先**: セキュリティ/ポリシー、ユーザー拡張機構（見落とされやすい）
   - **高優先**: メモリ/コンテキスト管理、エージェント/マルチエージェント
   - **中優先**: 既存ページの分割（1ページに2つ以上の関心事が混在している場合）
4. 追加ページにも `relevant_files`、`primary_exports` を偵察結果から割り当てる
5. 追加後、再度12領域チェックリストで検証する

**よくある見落としパターン：**
- 認証と設定を1ページに統合してしまい、セキュリティ/ポリシーが独立ページにならない
- スキル/プラグイン/カスタムコマンド等の拡張機構を既存ページの一部に埋没させてしまう
- テスト/品質基盤のページを省略してしまう
- コンテキスト管理（チャット圧縮、メモリ永続化等）を他ページに吸収してしまう

**例外**: ソースファイル数が50未満の小規模リポジトリに限り、10〜14ページでもよい。
その場合、必須カバレッジ領域のうち該当するものが全てカバーされていることを確認すること。

### Concise（5〜10ページ）
- 重要な機能のみ、フラット構造
- セクション1〜3個

## JSON出力仕様

**有効なJSON。コメント禁止。偵察結果で確認済みのパスのみ。**

```json
{
  "title": "string",
  "description": "string",
  "language": "string",
  "mode": "string - comprehensive | concise",
  "sections": [
    {
      "id": "string",
      "title": "string",
      "order": "number",
      "pages": [
        {
          "id": "string",
          "title": "string",
          "description": "string - このページ固有の責務（他ページとの違いがわかるように）",
          "relevant_files": ["string - 偵察結果で確認済みの実在パス"],
          "importance": "string - high | medium | low",
          "related_pages": ["string - 関連ページID。必ず含めること"],
          "suggested_diagrams": ["string - 推奨Mermaid図の名前。必ず含めること"],
          "primary_exports": ["string - 主要なexport名。必ず含めること"]
        }
      ]
    }
  ]
}
```

**全フィールド必須。** `related_pages`, `suggested_diagrams`, `primary_exports` が
空配列であっても省略してはならない。これらはページ生成時の品質に直接影響する。

## relevant_files の選定ルール

- 1ページあたり **3〜8ファイル**
- 偵察結果に export が含まれるファイルを優先
- 偵察結果で実在が確認できないパスは含めない
- index.ts（バレルファイル）は薄い。実体ファイルを指定
- **エンドツーエンドフローページ**: 横断的に 5〜10ファイルを指定してよい

## 必須チェックリスト

- [ ] 偵察結果の export のうち、どのページにも割り当てられていないものはないか
- [ ] 偵察結果セクション3の拡張機構がカバーされているか
- [ ] **README上の「プラグイン」「カスタム」「拡張」関連の機能がカバーされているか**
- [ ] **エンドツーエンドフローページが含まれているか（Comprehensiveモード）**
- [ ] 同じファイルが複数ページにある場合、description で責務の違いが明記されているか
- [ ] relevant_files が 1〜2 ファイルのページはないか
- [ ] _meta.json にコメントや推測が含まれていないか
