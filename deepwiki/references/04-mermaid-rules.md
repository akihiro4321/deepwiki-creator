# DeepWiki: Mermaidダイアグラム記述の厳密なルール

[SKILL.md](../SKILL.md) の **Phase 3: ページ単位の分析・生成ループ** 等でMermaidを書く際は、MarkdownパーサーおよびMermaidレンダリングエンジンでの**パースエラー・描画不能を絶対に防ぐため、以下のルールを完全に遵守すること。**

---

### 1. 縦方向 (Vertical) レイアウトの強制

- フローダイアグラムの指定には必ず `graph TD` (top-down) または `flowchart TD` を使用すること。
- **絶対に `graph LR` (left-right) や `flowchart LR` を使用しないこと。**
- ノード内のテキストは最大でも3-4単語に収め、横幅が長くなりすぎないようにすること。

---

### 2. シーケンス図 (Sequence Diagrams) の厳格なルール

- 先頭行に必ず単独で `sequenceDiagram` を配置すること。
- その直後に、使用する全参加者を `participant` キーワードで定義すること（例: `participant User`, `participant API as Backend`）。
- （オプション）アクターやデータベースの場合は `actor User`, `database DB` のように種類を指定すると良い。
- 以下のアロー構文（8種類）から意図に合ったものを正確に使用すること:
  - `->` : 実線・矢印なし (稀)
  - `-->` : 破線・矢印なし (稀)
  - `->>` : 実線・矢じりあり (**リクエストや呼び出しに最も使用**)
  - `-->>` : 破線・矢じりあり (**レスポンスや戻り値に最も使用**)
  - `->x` : 実線・末尾がX (エラー・失敗)
  - `-->x` : 破線・末尾がX (エラーレスポンス)
  - `-)` : 実線・オープンアロー (非同期、投げっぱなし)
  - `--)` : 破線・オープンアロー (非同期レスポンス)
- アクティベーションボックスには必ず `+`/`-` プレフィックスを使用すること（例: `A->>+B: Start`, `B-->>-A: End`）。
- 構造化要素（`loop`, `alt`, `opt`, `par`, `critical`, `break`）を複雑なフロー制御に積極的に用いること。
- メッセージへのラベル付与にはコロン（`:`）を用いること。**絶対にフローチャート風の `A--|label|-->B` 表記を使用しないこと。**
- 説明や捕捉はノート (`Note over A,B: Description`, `Note right of A: Detail`) を使用すること。
- 大規模なシーケンス図の場合は `autonumber` を付与すること。

---

### 3. 【🔥 致命的エラー防止: 全般的な構文ルール（絶対厳守）】

> [!CAUTION]
> **以下のルールに違反すると、生成されたWikiの図がすべて表示されなくなる致命的なエラーを引き起こす。**

- ノードラベルに `()`、`[]`、`{}` などの括弧や記号類が含まれる場合は、**例外なく必ず `["ラベル"]` のようにダブルクォーテーションで囲む**こと。クォート忘れは致命的なパースエラーを引き起こします。
- **【頻出エラー1】** `D[Data Pipeline (api/data_pipeline.py)]` のように `[]` の内側に `()` を含むとパースエラーで図が崩壊します。**必ず `D["Data Pipeline (api/data_pipeline.py)"]` とクォートで囲むか、括弧を使用しないでください。**
- **【頻出エラー2】** `cmd_start_sh(CMD ["/app/start.sh"])` のように `()` の内側に `[]` などの記号が含まれる場合もパースエラーになります。**必ず単一の文字列として `cmd_start_sh("CMD /app/start.sh")` のようにクォートするか、記号を削除してください。**
- HTMLタグは使用不可（`<` や `>` などの記号もパースエラーの原因になります）。
- ノード ID にハイフンを含めない（アンダースコアを使用すること。例: `node-1` ❌ → `node_1` ⭕️）。
- サンプルの汎用名ではなく、ソースコードに存在する**実際のクラス名・関数名**をノードラベルに用いること。
