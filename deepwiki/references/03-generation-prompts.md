# DeepWiki: ページ生成と品質基準フォーマット

[SKILL.md](../SKILL.md) の **Phase 3: ページ単位の分析・生成ループ** において、LLMが各Markdownページを生成する際の品質要件（文字数、スニペット等のルール）およびセルフレビューチェックリスト。

> **Mermaidダイアグラムの記述方法は、パースエラー防止のため必ず別ファイルの [04-mermaid-rules.md](04-mermaid-rules.md) を参照すること。**

---

## 1. ソースコード分析メモの出力フォーマット
ソースコードを精読した直後に、以下の形式でメモを作成し、そこからMarkdownに書き起こす。

```text
### ファイル: [パス] (L1-L[総行数] 読了)

■ スニペット候補（最重要 — ページ品質の核心）
  1. [候補名] (L開始-L終了): [なぜ重要か]
  2. [候補名] (L開始-L終了): [なぜ重要か]
  ... (必ず 5-10個リストアップする)

■ 設計パターン
  - [パターン名]: [該当箇所と理由] (L行番号)

■ テーブル化すべきデータ
  - 列挙型: [Enum名] (L行番号)
  - 定数一覧: [定数グループ] (L行番号)

■ データフロー
  - 入力 → 処理 → 出力
```

---

## 2. importance 別の最低要件（品質基準マトリクス）

| importance | 語数 | ダイアグラム | Mermaid種類 | コードスニペット | Sources 行 | テーブル |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| high | **1200語以上** | 2-3個 | **2種類以上** | **5-8個必須** | 全セクション | **1個以上** |
| medium | **600-1000語**| 1-2個 | 1種類以上 | **3-5個必須** | 全セクション | 推奨 |
| low | 300-500語 | 1個 | 1種類以上 | 1-2個 | 主要セクション | 任意 |

---

## 3. ページ生成の模範構成テンプレート

```markdown
## [ページタイトル（英語タイトルを記載）]

[2-3文の概要（日本語）。このページの目的とスコープを明確に記述する。]

## [主要セクション]

[設計パターン名] パターン（該当する場合）
[パターンの説明]

| カテゴリ | 要素 (`ClassName`) | 説明 |
| :--- | :--- | :--- |
| [分類] | `ToolRegistry` | [役割の説明] |

` ` `mermaid
flowchart TD
    A["ToolRegistry"] -->|"register()"| B["DeclarativeTool"]
` ` `

` ` `typescript
// packages/core/src/tools/tool-registry.ts:L100-L130
export class ToolRegistry {
  private tools = new Map<string, DeclarativeTool>();
  ...
}
` ` `

**Sources:** [tool-registry.ts:L100-L130](file:///path/to/tool-registry.ts#L100-L130)

## 関連ページ
- [← 前: ページタイトル](./対応ファイル名.md)
...
```

---

## 4. コードスニペットと Sources 行のルール
- スニペットは疑似コード禁止。実際のコードから抜粋する。
- スニペット冒頭に必ず出典コメント (`// パス:L開始-L終了`) を記載する。
- **Sources行**は各セクションの末尾に必ず配置し、**実際に参照した範囲（200行以内）の行番号を明記**する。（例: `[file.ts:L50-L100]`）。全行を指定する（例: `L1-L1000`）や、ページ末尾にまとめて1箇所に記載するのは減点対象。

---

## 5. セルフレビューチェックリストと失敗パターン対策

| 失敗パターン | 対策 |
| :--- | :--- |
| ページ数が少なすぎる（10ページ以下） | 規模ガイドラインを再確認。Core Systems は「1モジュール = 1ページ」が基本。 |
| Sources 行がない / 行番号が不適切 | ファイル閲覧直後に行番号をメモし、Sources に 200 行以内の正確な範囲を記載。 |
| Mermaid図が特定の1種類に偏る | importance: high なら `sequenceDiagram` や `classDiagram` など複数種類を取り入れる。 |
| スニペットが少ない・疑似コードが混入 | importance: high であれば 5〜8 個必ず「実際のコード」から抜粋する。 |
| セクション検証のバッチ処理化 | 全ページ一気に作成しないで、**1ページ生成後、必ず `validate_page.py` を通過させてから次へ進む**。 |

**セルフレビューチェックリスト (検証スクリプト呼び出し前)**
- [ ] 全セクションに `**Sources:**` 行があるか
- [ ] Sources に的確な行番号（`L100-L200`など）が含まれているか
- [ ] importance: high において 5 つ以上、medium で 3 つ以上のスニペットがあるか
- [ ] コードスニペットにファイル・行のコメントクレジットが付記されているか
- [ ] テーブル（Enumや定数、設定の一覧）が配置されているか
